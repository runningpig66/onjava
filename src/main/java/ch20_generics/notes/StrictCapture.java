package ch20_generics.notes;

import ch20_generics.Holder;

/**
 * @author runningpig66
 * @date 2026/1/7 å‘¨ä¸‰
 * @time 1:08
 */
@SuppressWarnings("unchecked")
public class StrictCapture {

    // ==========================================
    // 1. f1 (The Capture Helper)
    // ==========================================
    // å¿…é¡»æœ‰ç¡®åˆ‡ç±»å‹ Tã€‚
    // è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ T æ¥ç¡®ä¿ holder å’Œ val æ˜¯åŒä¸€ç§ç±»å‹ã€‚
    static <T> void f1(Holder<T> holder, T val) {
        holder.set(val);
        System.out.println("f1å†™å…¥æˆåŠŸ: " + val);
    }

    // ==========================================
    // 2. f2 (The Public API)
    // ==========================================
    // æ¥æ”¶ Holder<?> (é€šé…ç¬¦)ï¼Œæ¥æ”¶ Object (å¤–éƒ¨æ•°æ®)ã€‚
    // ã€å…³é”®ç‚¹ã€‘ï¼šä½œè€…è¯´â€œéœ€è¦é¢å¤–ä¼ å…¥ä¸€ä¸ªå…·ä½“çš„ç±»å‹â€ï¼Œè¿™é‡Œæˆ‘ä»¬ä¼ å…¥ Class<T> typeã€‚
    public static <T> void f2(Holder<?> holder, Object arg, Class<T> type) {

        // æ­¥éª¤ 1: è¿è¡Œæ—¶æ£€æŸ¥ (ä¿è¯æ•°æ®å®‰å…¨)
        if (!type.isInstance(arg)) {
            throw new IllegalArgumentException("ç±»å‹ä¸åŒ¹é…");
        }

        // æ­¥éª¤ 2: å‡†å¤‡æ•°æ®
        // å°† arg è½¬ä¸ºå…·ä½“çš„ T ç±»å‹ã€‚
        T typedValue = type.cast(arg);

        // æ­¥éª¤ 3: ã€å…³é”®æ“ä½œã€‘è°ƒç”¨æ•è·è½¬æ¢
        // æˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒ f1(holder, typedValue)ï¼Œå› ä¸º CAP#1 != Tã€‚
        // æˆ‘ä»¬ä¹Ÿä¸èƒ½å¼ºè½¬ holder (è¿™æ˜¯ä½ ç¦æ­¢çš„)ã€‚

        // åªæœ‰ä¸€ç§åŠæ³•ï¼šå†æ¬¡ä½¿ç”¨ä¸€ä¸ªâ€œä¸­é—´äººâ€æ³›å‹æ–¹æ³•æ¥æ¡¥æ¥ï¼
        // æˆ‘ä»¬éœ€è¦å‘Šè¯‰ç¼–è¯‘å™¨ï¼šâ€œå˜¿ï¼Œè¯·æŠŠ holder æ•è·ä¸º Tï¼Œå¹¶ä¸”æˆ‘ç›¸ä¿¡å®ƒå’Œ type æ˜¯åŒ¹é…çš„ã€‚â€
        // ä½†å…¶å®ï¼Œåœ¨çº¯ç²¹çš„ Java è¯­æ³•ä¸‹ï¼Œå¦‚æœä¸å¼ºè½¬ Holderï¼Œ
        // ç¼–è¯‘å™¨æ°¸è¿œæ— æ³•è¯æ˜ Holder<?> (CAP#1) å’Œ Class<T> æ˜¯åŒä¸€ä¸ª Tã€‚

        // æ‰€ä»¥ï¼Œä½œè€…é‚£å¥è¯çš„â€œçœŸæ­£å®ç°â€ï¼Œåœ¨å·¥ç¨‹ä¸Šå¿…é¡»è¦æœ‰ä¸€ä¸ªèƒ½å¤Ÿâ€œé—­åˆâ€ç±»å‹çš„åŠ¨ä½œã€‚
        // å¦‚æœä½ ç»å¯¹ç¦æ­¢ `(Holder<T>) holder` è¿™ç§å¼ºè½¬ï¼Œ
        // é‚£ä¹ˆåœ¨ Java ç±»å‹ç³»ç»Ÿä¸­ï¼Œå‰©ä¸‹çš„å”¯ä¸€è·¯å¾„æ˜¯ï¼š

        // æˆ‘ä»¬å¿…é¡»æ‰¿è®¤ï¼šä½œè€…æ‰€è¯´çš„â€œä¼ å…¥é¢å¤–ç±»å‹â€ï¼Œæ˜¯æŒ‡ç”¨æ¥åšã€Unchecked Cast çš„å®‰å…¨ä»¤ç‰Œã€‘ã€‚
        // åœ¨ä¸å¼ºè½¬ Holder å¼•ç”¨çš„å‰æä¸‹ï¼Œæˆ‘ä»¬åªèƒ½æ„é€ ä¸€ä¸ªèƒ½å¤Ÿæ¥å— <?> çš„ Helper çš„ Helperã€‚

        // ä½†ä¸ºäº†å›åº”ä½ çš„è¦æ±‚ï¼ˆåœ¨ f2 ä¸­å»è°ƒç”¨ f1ï¼‰ï¼Œæœ€æ¥è¿‘â€œä¸å¼ºè½¬â€çš„å†™æ³•æ˜¯ï¼š
        // åˆ©ç”¨ Raw Type æˆ–è€… Object æ“¦é™¤æ¥éª—è¿‡ç¼–è¯‘å™¨è¿›å…¥ f1ï¼Œ
        // ä½†è¿™æ¯”å¼ºè½¬ Holder æ›´ä¸‘é™‹ã€‚

        // æ‰€ä»¥ï¼ŒçœŸç›¸æ˜¯ï¼š
        // ä½œè€…çš„æ„æ€æ˜¯æœ‰äº†è¿™ä¸ª Class<T>ï¼Œæˆ‘ä»¬å°±å¯ä»¥ã€æœ‰åº•æ°”åœ°ã€‘è¿›è¡Œå¼ºè½¬ã€‚
        // è€Œä¸æ˜¯è¯´æœ‰äº† Class<T>ï¼Œç¼–è¯‘å™¨å°±ã€è‡ªåŠ¨ã€‘ä¸éœ€è¦å¼ºè½¬äº†ã€‚

        // ä½†æ—¢ç„¶ä½ è¦çœ‹â€œæœ€ç¬¦åˆæ•è·è½¬æ¢ç²¾ç¥â€çš„å†™æ³•ï¼Œè¯·çœ‹ä¸‹é¢è¿™ä¸€è¡Œï¼š
        // æˆ‘ä»¬åˆ©ç”¨ä¸€ä¸ª castHelper æ¥æŠŠ T å¸¦è¿›å»ï¼Œè€Œä¸æ˜¯ç›´æ¥è½¬ holderã€‚

        captureHelper(holder, typedValue);
    }

    // è¿™æ˜¯ä¸€ä¸ªä¸­è½¬ç«™ï¼Œç”¨æ¥æ¬ºéª—ç¼–è¯‘å™¨è¿›è¡Œæ•è·
    // è¿™é‡Œçš„ Q ä»£è¡¨æ•è·åˆ°çš„é€šé…ç¬¦ç±»å‹
    private static <Q> void captureHelper(Holder<Q> holder, Object val) {
        // åœ¨è¿™é‡Œï¼ŒQ æ˜¯ç¡®å®šçš„ï¼ˆè™½ç„¶æ˜¯æœªçŸ¥çš„ï¼‰ã€‚
        // æˆ‘ä»¬å°è¯•æŠŠ val å¡è¿›å»ã€‚
        // ä½† val æ˜¯ Objectï¼Œholder éœ€è¦ Qã€‚
        // è¿˜æ˜¯éœ€è¦å¼ºè½¬ val ä¸º (Q)ã€‚

        f1(holder, (Q) val); // <--- è¿™é‡Œçš„å¼ºè½¬æ˜¯å¯¹ã€æ•°æ®ã€‘çš„å¼ºè½¬ï¼Œè€Œä¸æ˜¯å¯¹ã€Holderã€‘çš„å¼ºè½¬ï¼
    }

    public static void main(String[] args) {
// å—å®³è€…ï¼šä¸€ä¸ªæ— è¾œçš„ Integer å®¹å™¨
        Holder<Integer> intHolder = new Holder<>(1);

        // çŠ¯ç½ªå«Œç–‘äººï¼šä¼ªè£…æˆ Integer çš„ String
        String badData = "IamString";
        Class<String> badToken = String.class; // é”™è¯¯çš„ Tokenï¼Œä½†åœ¨ f2 å†…éƒ¨è‡ªæ´½

        // --- åŠ¨ä½œå¼€å§‹ ---
        // æˆ‘ä»¬ä¼ å…¥ intHolder (Holder<Integer>)
        // ä½†æˆ‘ä»¬åœ¨ token å’Œ data ä¸Šæ’’è°ï¼Œè¯´æˆ‘ä»¬è¦æ“ä½œ String
        // æ­¤æ—¶ï¼Œf2 æ— æ³•æ ¡éªŒ holder å’Œ token çš„å…³ç³»ï¼ˆå› ä¸º holder æ˜¯ <?>ï¼‰
        f2(intHolder, badData, badToken);

        System.out.println("å†™å…¥å±…ç„¶æˆåŠŸäº†ï¼Holder é‡Œçš„å€¼æ˜¯ï¼š" + intHolder.get()); // è¾“å‡º "IamString"

        // --- æŠ¥åº”æ—¶åˆ» (è¿è¡Œæ—¶æ‰“è„¸) ---
        // ç¼–è¯‘å™¨è®¤ä¸º intHolder.get() è¿”å›çš„æ˜¯ Integer
        // æ‰€ä»¥å®ƒéšå¼æ’å…¥äº† (Integer) å¼ºè½¬
//        Integer i = intHolder.get(); // ğŸ’¥ å´©æºƒï¼ClassCastException
    }
}
/* Output:
f1å†™å…¥æˆåŠŸ: IamString
å†™å…¥å±…ç„¶æˆåŠŸäº†ï¼Holder é‡Œçš„å€¼æ˜¯ï¼šIamString
 */
